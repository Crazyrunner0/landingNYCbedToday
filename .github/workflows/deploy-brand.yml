name: Deploy Brand

on:
  workflow_dispatch:
    inputs:
      brand:
        description: 'Brand to deploy (e.g., nook-dresser-today, nook-mattress-today)'
        required: true
        default: 'nook-dresser-today'
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - staging
          - production
      dry_run:
        description: 'Run in dry-run mode (no actual deployment)'
        required: false
        type: boolean
        default: false

env:
  DRY_RUN: ${{ github.event.inputs.dry_run == 'true' && 'true' || 'false' }}
  BRAND: ${{ github.event.inputs.brand }}
  TARGET_ENV: ${{ github.event.inputs.environment }}

jobs:
  validate:
    name: Validate Brand Configuration
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, xml, ctype, iconv, intl, pdo_mysql, dom, filter, gd, json, opcache, bcmath
          coverage: none

      - name: Validate brand configuration
        run: |
          php -r "
            \$config = include 'config/brands/${{ env.BRAND }}.php';
            if (!is_array(\$config) || empty(\$config['id'])) {
              echo 'Error: Invalid brand configuration for ${{ env.BRAND }}\n';
              exit(1);
            }
            echo 'Brand: ' . \$config['display_name'] . '\n';
            echo 'ID: ' . \$config['id'] . '\n';
            echo 'Valid configuration\n';
          "

      - name: Cache Composer packages
        uses: actions/cache@v3
        with:
          path: vendor
          key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-php-

      - name: Install dependencies
        run: composer install --prefer-dist --no-progress --no-suggest

      - name: Validate composer.json
        run: composer validate --strict

  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    needs: validate

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, xml, ctype, iconv, intl, pdo_mysql
          coverage: none
          tools: phpcs

      - name: Cache Composer packages
        uses: actions/cache@v3
        with:
          path: vendor
          key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-php-

      - name: Install dependencies
        run: composer install --prefer-dist --no-progress --no-suggest

      - name: Run PHP_CodeSniffer
        run: composer test

  build:
    name: Build Assets
    runs-on: ubuntu-latest
    needs: [validate, code-quality]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, xml, ctype, iconv, intl, pdo_mysql
          coverage: none

      - name: Cache Composer packages
        uses: actions/cache@v3
        with:
          path: vendor
          key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-php-

      - name: Cache NPM packages
        uses: actions/cache@v3
        with:
          path: node_modules
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      - name: Install Composer dependencies
        run: composer install --prefer-dist --no-progress --no-suggest

      - name: Install NPM dependencies
        run: npm install

      - name: Build frontend assets
        run: npm run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: build-${{ env.BRAND }}
          path: |
            build/
            dist/
          retention-days: 1

  deploy:
    name: Deploy to ${{ github.event.inputs.environment }}
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v3
        with:
          name: build-${{ env.BRAND }}

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets[format('DEPLOY_{0}_SSH_KEY', env.TARGET_ENV)] }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets[format('DEPLOY_{0}_HOST', env.TARGET_ENV)] }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Deploy brand
        run: |
          DEPLOY_HOST="${{ secrets[format('DEPLOY_{0}_HOST', env.TARGET_ENV)] }}"
          DEPLOY_PATH="${{ secrets[format('DEPLOY_{0}_PATH', env.TARGET_ENV)] }}"
          DEPLOY_USER="${{ secrets[format('DEPLOY_{0}_USER', env.TARGET_ENV)] }}"

          if [ "${{ env.DRY_RUN }}" = "true" ]; then
            echo "=== DRY RUN: Brand Deployment ===="
            echo "Brand: ${{ env.BRAND }}"
            echo "Environment: ${{ env.TARGET_ENV }}"
            echo "Host: $DEPLOY_HOST"
            echo "Path: $DEPLOY_PATH"
            echo "================================="
          else
            echo "Deploying ${{ env.BRAND }} to ${{ env.TARGET_ENV }}..."
            
            # Example deployment (customize for your infrastructure)
            rsync -avz \
              --delete \
              --exclude '.git' \
              --exclude 'node_modules' \
              --exclude 'vendor' \
              -e "ssh -i ~/.ssh/deploy_key" \
              ./ "$DEPLOY_USER@$DEPLOY_HOST:$DEPLOY_PATH/"
            
            # Run post-deployment tasks
            ssh -i ~/.ssh/deploy_key "$DEPLOY_USER@$DEPLOY_HOST" << 'REMOTE_COMMANDS'
              cd ${{ secrets[format('DEPLOY_{0}_PATH', env.TARGET_ENV)] }}
              
              # Set environment variable for brand
              echo 'WP_BRAND=${{ env.BRAND }}' >> .env
              
              # Clear caches
              wp cache flush --allow-root
              
              # Optional: Run setup commands
              # wp db migrate --allow-root
            REMOTE_COMMANDS
          fi

      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/deploy_key

      - name: Send Slack notification
        if: failure()
        uses: slackapi/slack-github-action@v1
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK }}
          payload: |
            {
              "text": "ðŸš¨ Deployment failed for ${{ env.BRAND }} to ${{ env.TARGET_ENV }}"
            }

      - name: Send Slack notification
        if: success()
        uses: slackapi/slack-github-action@v1
        with:
          webhook-url: ${{ secrets.SLACK_WEBHOOK }}
          payload: |
            {
              "text": "âœ… Successfully deployed ${{ env.BRAND }} to ${{ env.TARGET_ENV }}"
            }
